<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­è·¯å¾‘èˆ‡è½‰å ´è¨ˆç®—ç³»çµ± (Pro)</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #10b981;
            --warning: #f59e0b;
            --gray: #f8fafc;
            --border: #e2e8f0;
            --text: #334155;
            --highlight: #eff6ff;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            color: var(--text);
            background: #f1f5f9;
            font-size: 14px;
        }

        h1, h2 { color: #0f172a; margin-top: 0; }

        /* Card & Layout */
        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .input-group { display: flex; align-items: center; gap: 8px; }
        .input-group label { font-weight: 600; color: #475569; }

        input, select {
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
        button.success { background: var(--success); }
        button.warning { background: var(--warning); color: white; }
        button.dark { background: #334155; }

        /* Address Manager */
        .address-container {
            height: 180px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: #fff;
        }
        .address-row {
            display: grid;
            grid-template-columns: 120px 1fr 1fr 50px;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--gray);
            align-items: center;
        }
        .address-row:nth-child(even) { background: #f8fafc; }
        .addr-clean { color: var(--success); font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Main Table */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        th, td { padding: 12px; border: 1px solid var(--border); vertical-align: middle; }
        th { background: #f1f5f9; text-align: left; font-weight: 700; color: #475569; position: sticky; top: 0; z-index: 10; }

        .col-date { width: 90px; text-align: center; font-weight: 700; color: var(--primary); background: #fff; }
        .col-time { width: 130px; font-variant-numeric: tabular-nums; }
        .col-info { min-width: 200px; }
        
        /* Transit Columns */
        .col-transit-info { width: 220px; background: #fffbeb; font-size: 0.9em; }
        .col-transit-final { width: 100px; text-align: center; background: #ecfdf5; font-weight: 700; color: #047857; }
        .col-daily { width: 100px; text-align: center; background: #fef2f2; font-weight: 700; color: #b91c1c; }

        /* Elements */
        .name-tag {
            display: inline-block; padding: 2px 8px; background: #e0f2fe; color: #0369a1;
            border-radius: 12px; font-weight: 600; font-size: 0.85em; margin-bottom: 4px;
        }
        .addr-text { color: #64748b; font-size: 0.9em; display: flex; align-items: center; gap: 4px; }
        
        .transit-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .t-label { color: #94a3b8; }
        .t-val { font-weight: 600; }
        .gap-val { color: #64748b; }
        .api-val { color: #d97706; }

        /* Logger & Progress */
        .log-panel {
            background: #1e293b; color: #34d399; padding: 15px; border-radius: 8px;
            font-family: 'Consolas', monospace; font-size: 13px; height: 120px; overflow-y: auto;
            margin-top: 15px; display: none;
        }
        .log-item { border-bottom: 1px solid #334155; padding: 2px 0; }
        .log-err { color: #f87171; }
        
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 10px; display: none;}
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

        /* Footer Total */
        .total-row { background: #1e293b; color: white; font-weight: bold; font-size: 1.1em; }
        .total-row td { border: 1px solid #334155; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <div>
            <h1 style="margin:0;">æ’ç­è·¯å¾‘èˆ‡è½‰å ´è¨ˆç®—ç³»çµ± <span style="font-size:0.5em; background:#2563eb; color:white; padding:2px 6px; border-radius:4px;">Pro</span></h1>
        </div>
        <div style="text-align:right;">
             <button class="dark" onclick="exportToCSV()" id="exportBtnTop">ğŸ“¥ åŒ¯å‡ºå ±è¡¨ (CSV)</button>
        </div>
    </div>

    <section class="card">
        <h2>1. è³‡æ–™åŒ¯å…¥èˆ‡è¨­å®š</h2>
        <div class="controls">
            <div class="input-group">
                <label>API Key:</label>
                <input type="password" id="apiKey" placeholder="Google Maps API Key" style="width: 220px;">
            </div>
            <div class="input-group">
                <label>å¹´ä»½:</label>
                <input type="number" id="yearInput" value="2026" style="width: 70px;">
            </div>
            <div class="input-group">
                <label>æœˆä»½:</label>
                <input type="number" id="monthInput" value="1" style="width: 60px;">
            </div>
        </div>

        <div class="controls" style="background:white; border:none; padding:0;">
            <div class="input-group">
                <label>åœ°å€åº« (address.csv):</label>
                <input type="file" id="addressInput" accept=".csv,.json">
            </div>
            <div class="input-group">
                <label>ç­è¡¨ (DATA.csv):</label>
                <input type="file" id="scheduleInput" accept=".csv">
            </div>
            <div style="margin-left:auto; display:flex; gap:10px;">
                <button id="addPersonBtn" class="success" style="font-size:0.9em">+ æ‰‹å‹•æ–°å¢äººå“¡</button>
                <button id="backupBtn" style="font-size:0.9em; background:#64748b;">å‚™ä»½åœ°å€ JSON</button>
            </div>
        </div>

        <div id="addressList" class="address-container">
            <div style="padding:40px; text-align:center; color:#94a3b8">è«‹å…ˆåŒ¯å…¥ address.csv</div>
        </div>
    </section>

    <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2>2. è¨ˆç®—çµæœ</h2>
            <div style="display:flex; align-items:center; gap:15px;">
                <span id="statusText" style="font-weight:600; color:#475569;"></span>
                <button id="calcBtn" class="warning" onclick="calculateAllTransits()">
                    ğŸš€ é–‹å§‹è¨ˆç®—è½‰å ´
                </button>
            </div>
        </div>

        <div id="progressContainer" class="progress-track">
            <div id="progressBar" class="progress-fill"></div>
        </div>
        <div id="logConsole" class="log-panel"></div>

        <div class="table-container">
            <table id="finalTable">
                <thead>
                    <tr>
                        <th class="col-date">æ—¥æœŸ</th>
                        <th class="col-time">æ™‚é–“</th>
                        <th class="col-info">äººå“¡èˆ‡åœ°é»</th>
                        <th class="col-transit-info">è½‰å ´è³‡è¨Š (Gap vs API)</th>
                        <th class="col-transit-final">æ¡è¨ˆ (å–çŸ­)</th>
                        <th class="col-daily">ç•¶æ—¥ç´¯è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center; padding: 40px; color:#cbd5e1">ç„¡è³‡æ–™</td></tr>
                </tbody>
                <tfoot id="tableFooter">
                    </tfoot>
            </table>
        </div>
    </section>

<script>
/**
 * ------------------------------------------------------------------
 * 1. UTILS & PARSERS
 * ------------------------------------------------------------------
 */
const parseCSV = (text) => {
    const arr = [];
    let quote = false, col = 0, row = 0, c = 0;
    for (; c < text.length; c++) {
        let cc = text[c], nc = text[c+1];
        arr[row] = arr[row] || [];
        arr[row][col] = arr[row][col] || '';
        if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
        if (cc == '"') { quote = !quote; continue; }
        if (cc == ',' && !quote) { ++col; continue; }
        if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
        if (cc == '\n' && !quote) { ++row; col = 0; continue; }
        if (cc == '\r' && !quote) { ++row; col = 0; continue; }
        arr[row][col] += cc;
    }
    return arr;
};

const cleanAddress = (rawAddr) => {
    if (!rawAddr) return '';
    let addr = rawAddr.trim();
    addr = addr.replace(/\d+é„°/g, '');
    addr = addr.replace(/([ç¸£å¸‚å€é„‰é®])([^ç¸£å¸‚å€é„‰é®]+?)[é‡Œæ‘]/g, '$1');
    const match = addr.match(/^(.*?è™Ÿ)/);
    if (match) addr = match[1];
    return addr;
};

const parseTime = (timeStr) => {
    // Convert "08:00" to minutes from midnight
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
};

const formatDuration = (mins) => {
    if (mins === 0) return '0åˆ†';
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return h > 0 ? `${h}æ™‚${m}åˆ†` : `${m}åˆ†`;
};

const parseScheduleCell = (cellText) => {
    if (!cellText) return [];
    const lines = cellText.split(/\r?\n/);
    const results = [];
    const regex = /(\d{1,2}:\d{2})(?:~(\d{1,2}:\d{2}))?\s+(.+)/;
    lines.forEach(line => {
        const match = line.trim().match(regex);
        if (match) {
            results.push({
                startTime: match[1],
                endTime: match[2] || '',
                name: match[3].trim()
            });
        }
    });
    return results;
};

/**
 * ------------------------------------------------------------------
 * 2. DATA PROCESSING
 * ------------------------------------------------------------------
 */
const state = {
    addresses: [],
    scheduleMap: {}, // Date -> Event[]
    rawScheduleRows: [],
    monthlyTotalMins: 0
};

const processSchedule = (rows, year, month) => {
    if (rows.length < 2) return {};
    const eventsByDate = {};
    const processedKeys = new Set();

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        let isDateRow = false;
        // Check if row has dates (numbers)
        for(let c=0; c < Math.min(row.length, 7); c++) {
            if (row[c] && /^\s*\d+/.test(row[c])) { isDateRow = true; break; }
        }

        if (isDateRow) {
            const dataRow = rows[i+1];
            if (!dataRow) continue;
            
            row.forEach((dateCell, colIndex) => {
                if (!dateCell) return;
                const dayMatch = dateCell.match(/^\s*(\d+)/);
                if (!dayMatch) return;
                
                const dayNum = parseInt(dayMatch[1]);
                const fullDate = `${year}-${month.toString().padStart(2,'0')}-${dayNum.toString().padStart(2,'0')}`;
                
                if (!eventsByDate[fullDate]) eventsByDate[fullDate] = [];
                
                if (dataRow[colIndex]) {
                    const tasks = parseScheduleCell(dataRow[colIndex]);
                    tasks.forEach(task => {
                        const key = `${fullDate}|${task.startTime}|${task.name}`;
                        if (!processedKeys.has(key)) {
                            processedKeys.add(key);
                            eventsByDate[fullDate].push({
                                ...task,
                                id: Math.random().toString(36).substr(2, 9),
                                // State for calculation
                                gapMinutes: null,
                                apiMinutes: null,
                                finalMinutes: null, // Min(gap, api)
                                transitError: null
                            });
                        }
                    });
                }
            });
            i++; 
        }
    }

    // Sort and Calculate Gaps (Pre-calculation)
    Object.keys(eventsByDate).forEach(date => {
        const events = eventsByDate[date];
        events.sort((a, b) => a.startTime.localeCompare(b.startTime));
        
        // Calculate Gaps between i and i+1
        for (let j = 0; j < events.length - 1; j++) {
            const current = events[j];
            const next = events[j+1];
            if (current.endTime && next.startTime) {
                const endMins = parseTime(current.endTime);
                const startMins = parseTime(next.startTime);
                let diff = startMins - endMins;
                if (diff < 0) diff = 0; // Overlap or error
                current.gapMinutes = diff;
            }
        }
    });

    return eventsByDate;
};

/**
 * ------------------------------------------------------------------
 * 3. API & LOGIC
 * ------------------------------------------------------------------
 */
const log = (msg, type='info') => {
    const box = document.getElementById('logConsole');
    const div = document.createElement('div');
    div.className = 'log-item ' + (type==='error'?'log-err':'');
    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
};

const callRoutesAPI = async (origin, dest, apiKey) => {
    try {
        const res = await fetch('https://routes.googleapis.com/directions/v2:computeRoutes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': apiKey,
                'X-Goog-FieldMask': 'routes.duration'
            },
            body: JSON.stringify({
                origin: { address: origin },
                destination: { address: dest },
                travelMode: 'DRIVE'
            })
        });
        if (!res.ok) throw new Error((await res.json()).error?.message || 'Error');
        const data = await res.json();
        if (data.routes?.[0]?.duration) {
            return parseInt(data.routes[0].duration.replace('s',''));
        }
        return 0;
    } catch(e) { throw e; }
};

const calculateAllTransits = async () => {
    const apiKey = document.getElementById('apiKey').value.trim();
    if (!apiKey) return alert('è«‹è¼¸å…¥ API Key');
    localStorage.setItem('my_routes_api_key', apiKey);

    const btn = document.getElementById('calcBtn');
    const bar = document.getElementById('progressBar');
    const logBox = document.getElementById('logConsole');
    
    btn.disabled = true;
    logBox.style.display = 'block';
    document.getElementById('progressContainer').style.display = 'block';
    logBox.innerHTML = '';
    log('é–‹å§‹è¨ˆç®—...');

    // Prepare Address Map
    const addrMap = state.addresses.reduce((acc,cur) => {
        acc[cur.name] = cleanAddress(cur.address); return acc;
    }, {});

    const dates = Object.keys(state.scheduleMap).sort();
    let tasks = [];
    
    // Build Task List
    dates.forEach(date => {
        const events = state.scheduleMap[date];
        for(let i=0; i<events.length-1; i++) {
            tasks.push({ date, idx: i, current: events[i], next: events[i+1] });
        }
    });

    log(`å…±éœ€è¨ˆç®— ${tasks.length} ç­†è·¯å¾‘`);

    for(let i=0; i<tasks.length; i++) {
        const { current, next } = tasks[i];
        const origin = addrMap[current.name];
        const dest = addrMap[next.name];
        
        // Update UI
        bar.style.width = `${Math.round(((i+1)/tasks.length)*100)}%`;
        document.getElementById('statusText').textContent = `${i+1}/${tasks.length}`;

        if(!origin || !dest) {
            current.transitError = 'åœ°å€ä¸å…¨';
            log(`è·³é: ${current.name}->${next.name} (ç„¡åœ°å€)`, 'error');
            continue;
        }

        try {
            const sec = await callRoutesAPI(origin, dest, apiKey);
            current.apiMinutes = Math.ceil(sec / 60);
            
            // Logic: Min(Gap, API)
            // If Gap is null (no end time), assume API time? 
            // Usually gap exists. If gap < 0, use 0.
            const gap = current.gapMinutes !== null ? current.gapMinutes : 9999;
            current.finalMinutes = Math.min(gap, current.apiMinutes);
            
            log(`OK: ${current.name}->${next.name} (Gap:${gap}m, API:${current.apiMinutes}m) => æ¡è¨ˆ:${current.finalMinutes}m`);
            
            // Rate Limit Buffer
            await new Promise(r => setTimeout(r, 250));
            
        } catch(e) {
            current.transitError = 'API Error';
            log(`API Error: ${e.message}`, 'error');
        }

        if(i % 5 === 0) renderTable();
    }

    renderTable();
    btn.disabled = false;
    log('è¨ˆç®—å®Œæˆ');
};

/**
 * ------------------------------------------------------------------
 * 4. RENDERERS
 * ------------------------------------------------------------------
 */
const renderAddressList = () => {
    const container = document.getElementById('addressList');
    container.innerHTML = '';
    state.addresses.forEach(p => {
        const div = document.createElement('div');
        div.className = 'address-row';
        div.innerHTML = `
            <input value="${p.name}" onchange="updateAddr('${p.id}','name',this.value)">
            <input value="${p.address}" onchange="updateAddr('${p.id}','address',this.value)">
            <div class="addr-clean" title="${cleanAddress(p.address)}">ğŸ“ ${cleanAddress(p.address)}</div>
            <button class="danger" style="padding:4px 8px" onclick="removeAddr('${p.id}')">âœ•</button>
        `;
        container.appendChild(div);
    });
};

const renderTable = () => {
    const tbody = document.getElementById('tableBody');
    const tfoot = document.getElementById('tableFooter');
    tbody.innerHTML = '';
    tfoot.innerHTML = '';
    
    const dates = Object.keys(state.scheduleMap).sort();
    const addrMap = state.addresses.reduce((acc,cur) => {
        acc[cur.name] = cleanAddress(cur.address); return acc;
    }, {});

    let monthlyTotal = 0;

    if(dates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px">ç„¡è³‡æ–™</td></tr>';
        return;
    }

    dates.forEach(date => {
        const events = state.scheduleMap[date];
        
        // Calculate Daily Total (Sum of finalMinutes)
        let dailyTotal = 0;
        events.forEach(e => {
            if (e.finalMinutes !== null) dailyTotal += e.finalMinutes;
        });
        monthlyTotal += dailyTotal;

        events.forEach((evt, idx) => {
            const tr = document.createElement('tr');
            
            // 1. Date (Rowspan)
            if(idx === 0) {
                const td = document.createElement('td');
                td.rowSpan = events.length;
                td.className = 'col-date';
                td.textContent = date.slice(5); // MM-DD
                tr.appendChild(td);
            }

            // 2. Time
            const tdTime = document.createElement('td');
            tdTime.className = 'col-time';
            tdTime.innerHTML = `<b>${evt.startTime}</b><br><span style="color:#94a3b8; font-size:0.9em">~${evt.endTime}</span>`;
            tr.appendChild(tdTime);

            // 3. Info
            const tdInfo = document.createElement('td');
            tdInfo.className = 'col-info';
            const addr = addrMap[evt.name];
            tdInfo.innerHTML = `
                <div class="name-tag">${evt.name}</div>
                <div class="addr-text">${addr ? 'ğŸ“ '+addr : '<span style="color:red">âš ï¸ ç¼ºåœ°å€</span>'}</div>
            `;
            tr.appendChild(tdInfo);

            // 4. Transit Info (Gap vs API)
            const tdTransit = document.createElement('td');
            tdTransit.className = 'col-transit-info';
            
            if(idx < events.length - 1) {
                const nextName = events[idx+1].name;
                let html = `<div style="margin-bottom:4px; font-weight:600; font-size:0.85em; color:#475569">å¾€: ${nextName}</div>`;
                
                // Gap
                const gapDisplay = evt.gapMinutes !== null ? `${evt.gapMinutes}åˆ†` : '?';
                html += `<div class="transit-row gap-val"><span class="t-label">ğŸ•’ é–“éš”:</span> <span class="t-val">${gapDisplay}</span></div>`;
                
                // API
                if (evt.apiMinutes !== null) {
                    html += `<div class="transit-row api-val"><span class="t-label">ğŸš— Google:</span> <span class="t-val">${evt.apiMinutes}åˆ†</span></div>`;
                } else if (evt.transitError) {
                    html += `<div class="transit-row"><span class="t-label">Google:</span> <span style="color:red">${evt.transitError}</span></div>`;
                } else {
                    html += `<div class="transit-row"><span class="t-label">Google:</span> <span style="color:#ccc">-</span></div>`;
                }
                tdTransit.innerHTML = html;
            } else {
                tdTransit.innerHTML = '<span style="color:#cbd5e1">(çµæŸ)</span>';
            }
            tr.appendChild(tdTransit);

            // 5. Final (Min)
            const tdFinal = document.createElement('td');
            tdFinal.className = 'col-transit-final';
            if(idx < events.length - 1) {
                if(evt.finalMinutes !== null) {
                    tdFinal.textContent = `${evt.finalMinutes} åˆ†`;
                    // Highlight if limited by Gap
                    if(evt.gapMinutes < evt.apiMinutes) {
                        tdFinal.title = "å·²å–è¼ƒçŸ­æ™‚é–“ (å—é™æ–¼é–“éš”)";
                        tdFinal.style.color = "#b45309"; // brownish
                    }
                } else {
                    tdFinal.textContent = '-';
                }
            }
            tr.appendChild(tdFinal);

            // 6. Daily Total (Rowspan)
            if(idx === 0) {
                const tdTotal = document.createElement('td');
                tdTotal.rowSpan = events.length;
                tdTotal.className = 'col-daily';
                tdTotal.textContent = formatDuration(dailyTotal);
                tr.appendChild(tdTotal);
            }

            tbody.appendChild(tr);
        });
    });

    // Footer Total
    const trFoot = document.createElement('tr');
    trFoot.className = 'total-row';
    trFoot.innerHTML = `
        <td colspan="5" style="text-align:right; padding-right:20px;">å…¨æœˆç¸½è¨ˆè½‰å ´æ™‚é–“:</td>
        <td style="text-align:center; color:#fca5a5;">${formatDuration(monthlyTotal)}</td>
    `;
    tfoot.appendChild(trFoot);
    
    state.monthlyTotalMins = monthlyTotal;
};

/**
 * ------------------------------------------------------------------
 * 5. EVENTS & EXPORT
 * ------------------------------------------------------------------
 */
const exportToCSV = () => {
    if (!state.scheduleMap || Object.keys(state.scheduleMap).length === 0) return alert('ç„¡è³‡æ–™å¯åŒ¯å‡º');
    
    // Headers
    let csvContent = '\uFEFF'; // BOM for Excel
    csvContent += "æ—¥æœŸ,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,å§“å,åœ°å€,ä¸‹ä¸€ç«™å§“å,ä¸‹ä¸€ç«™åœ°å€,æ’ç¨‹é–“éš”(åˆ†),Googleé ä¼°(åˆ†),æ¡è¨ˆæ™‚é–“(åˆ†),ç•¶æ—¥ç´¯è¨ˆ(åˆ†)\n";

    const dates = Object.keys(state.scheduleMap).sort();
    const addrMap = state.addresses.reduce((acc,cur) => {
        acc[cur.name] = cleanAddress(cur.address); return acc;
    }, {});

    dates.forEach(date => {
        const events = state.scheduleMap[date];
        
        // Calc Daily Total First
        let dailyTotal = 0;
        events.forEach(e => { if(e.finalMinutes) dailyTotal += e.finalMinutes; });

        events.forEach((e, i) => {
            const addr = addrMap[e.name] || '';
            let nextName = '', nextAddr = '', gap = '', api = '', final = '';
            
            if (i < events.length - 1) {
                const next = events[i+1];
                nextName = next.name;
                nextAddr = addrMap[next.name] || '';
                gap = e.gapMinutes !== null ? e.gapMinutes : '';
                api = e.apiMinutes !== null ? e.apiMinutes : '';
                final = e.finalMinutes !== null ? e.finalMinutes : '';
            }

            // Only show daily total on first row
            const dailyTotalStr = (i === 0) ? dailyTotal : '';

            // Escape fields
            const row = [
                date, e.startTime, e.endTime, e.name, addr,
                nextName, nextAddr, gap, api, final, dailyTotalStr
            ].map(f => `"${String(f).replace(/"/g, '""')}"`).join(',');
            
            csvContent += row + "\n";
        });
    });
    
    // Add Footer to CSV
    csvContent += `,,,,,,,,,"å…¨æœˆç¸½è¨ˆ",${state.monthlyTotalMins}\n`;

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'schedule_export.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// Global Helpers for Inline Events
window.updateAddr = (id, f, v) => {
    const p = state.addresses.find(x => x.id == id);
    if(p) { p[f] = v; renderAddressList(); processAndRender(); }
};
window.removeAddr = (id) => {
    if(confirm('åˆªé™¤?')) {
        state.addresses = state.addresses.filter(x => x.id != id);
        renderAddressList(); processAndRender();
    }
};

const processAndRender = () => {
    const y = document.getElementById('yearInput').value;
    const m = document.getElementById('monthInput').value;
    state.scheduleMap = processSchedule(state.rawScheduleRows, y, m);
    renderTable();
};

// Init
window.addEventListener('DOMContentLoaded', () => {
    const k = localStorage.getItem('my_routes_api_key');
    if(k) document.getElementById('apiKey').value = k;
});

document.getElementById('addressInput').addEventListener('change', async (e) => {
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    if(f.name.endsWith('.json')) state.addresses = JSON.parse(txt);
    else state.addresses = parseCSV(txt).filter(r=>r[0]).map((r,i)=>({id:'a'+i,name:r[0].trim(),address:r[1].trim()}));
    renderAddressList(); processAndRender();
});

document.getElementById('scheduleInput').addEventListener('change', async (e) => {
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    state.rawScheduleRows = parseCSV(txt);
    processAndRender();
});

document.getElementById('addPersonBtn').addEventListener('click', () => {
    state.addresses.unshift({id:'n'+Date.now(), name:'æ–°äººå“¡', address:''});
    renderAddressList();
});
document.getElementById('backupBtn').addEventListener('click', () => {
    const b = new Blob([JSON.stringify(state.addresses,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='address.json'; a.click();
});
document.getElementById('yearInput').addEventListener('change', processAndRender);
document.getElementById('monthInput').addEventListener('change', processAndRender);

</script>
</body>
</html>
